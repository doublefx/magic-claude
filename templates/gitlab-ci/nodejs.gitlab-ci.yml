stages:
  - detect
  - build
  - test
  - security
  - deploy

variables:
  NODE_ENV: "test"

detect-package-manager:
  stage: detect
  image: node:20-alpine
  script:
    - |
      if [ -f "pnpm-lock.yaml" ]; then
        echo "PACKAGE_MANAGER=pnpm" >> package-manager.env
        echo "LOCKFILE=pnpm-lock.yaml" >> package-manager.env
      elif [ -f "yarn.lock" ]; then
        echo "PACKAGE_MANAGER=yarn" >> package-manager.env
        echo "LOCKFILE=yarn.lock" >> package-manager.env
      elif [ -f "bun.lockb" ]; then
        echo "PACKAGE_MANAGER=bun" >> package-manager.env
        echo "LOCKFILE=bun.lockb" >> package-manager.env
      else
        echo "PACKAGE_MANAGER=npm" >> package-manager.env
        echo "LOCKFILE=package-lock.json" >> package-manager.env
      fi
  artifacts:
    reports:
      dotenv: package-manager.env

build:node-18:
  stage: build
  image: node:18-alpine
  needs: ["detect-package-manager"]
  cache:
    key:
      files:
        - package-lock.json
        - yarn.lock
        - pnpm-lock.yaml
    paths:
      - node_modules/
      - .npm/
      - .yarn/
      - .pnpm-store/
  script:
    - |
      if [ "$PACKAGE_MANAGER" = "pnpm" ]; then
        npm install -g pnpm
        pnpm install --frozen-lockfile
      elif [ "$PACKAGE_MANAGER" = "yarn" ]; then
        yarn install --frozen-lockfile
      elif [ "$PACKAGE_MANAGER" = "bun" ]; then
        npm install -g bun
        bun install --frozen-lockfile
      else
        npm ci
      fi
    - |
      if grep -q '"build"' package.json; then
        $PACKAGE_MANAGER run build
      fi
  artifacts:
    paths:
      - dist/
      - build/
      - .next/
    expire_in: 1 week

build:node-20:
  stage: build
  image: node:20-alpine
  needs: ["detect-package-manager"]
  cache:
    key:
      files:
        - package-lock.json
        - yarn.lock
        - pnpm-lock.yaml
    paths:
      - node_modules/
      - .npm/
      - .yarn/
      - .pnpm-store/
  script:
    - |
      if [ "$PACKAGE_MANAGER" = "pnpm" ]; then
        npm install -g pnpm
        pnpm install --frozen-lockfile
      elif [ "$PACKAGE_MANAGER" = "yarn" ]; then
        yarn install --frozen-lockfile
      elif [ "$PACKAGE_MANAGER" = "bun" ]; then
        npm install -g bun
        bun install --frozen-lockfile
      else
        npm ci
      fi
    - |
      if grep -q '"build"' package.json; then
        $PACKAGE_MANAGER run build
      fi
  artifacts:
    paths:
      - dist/
      - build/
      - .next/
    expire_in: 1 week

build:node-22:
  stage: build
  image: node:22-alpine
  needs: ["detect-package-manager"]
  cache:
    key:
      files:
        - package-lock.json
        - yarn.lock
        - pnpm-lock.yaml
    paths:
      - node_modules/
      - .npm/
      - .yarn/
      - .pnpm-store/
  script:
    - |
      if [ "$PACKAGE_MANAGER" = "pnpm" ]; then
        npm install -g pnpm
        pnpm install --frozen-lockfile
      elif [ "$PACKAGE_MANAGER" = "yarn" ]; then
        yarn install --frozen-lockfile
      elif [ "$PACKAGE_MANAGER" = "bun" ]; then
        npm install -g bun
        bun install --frozen-lockfile
      else
        npm ci
      fi
    - |
      if grep -q '"build"' package.json; then
        $PACKAGE_MANAGER run build
      fi
  artifacts:
    paths:
      - dist/
      - build/
      - .next/
    expire_in: 1 week

lint:
  stage: test
  image: node:20-alpine
  needs: ["build:node-20"]
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  script:
    - npm ci
    - |
      if grep -q '"lint"' package.json; then
        npm run lint
      else
        echo "No lint script found"
      fi

test:node-18:
  stage: test
  image: node:18-alpine
  needs: ["build:node-18"]
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  script:
    - npm ci
    - |
      if grep -q '"test"' package.json; then
        npm run test -- --coverage
      fi
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week

test:node-20:
  stage: test
  image: node:20-alpine
  needs: ["build:node-20"]
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  script:
    - npm ci
    - |
      if grep -q '"test"' package.json; then
        npm run test -- --coverage
      fi
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week

test:node-22:
  stage: test
  image: node:22-alpine
  needs: ["build:node-22"]
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
  script:
    - npm ci
    - |
      if grep -q '"test"' package.json; then
        npm run test -- --coverage
      fi
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week

security:npm-audit:
  stage: security
  image: node:20-alpine
  needs: []
  script:
    - npm audit --audit-level=moderate || true
  allow_failure: true

security:gitleaks:
  stage: security
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  needs: []
  script:
    - gitleaks detect --source . --verbose
  allow_failure: true
